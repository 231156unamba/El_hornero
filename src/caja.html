<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Módulo de Caja</title>
</head>
<body>

<h2>Módulo de Caja</h2>

<div class="container">
    <div class="row">
        <div class="col-md-6">
            <button id="btnAbrir" class="btn btn-success mb-2">Abrir Caja</button>
            <button id="btnCerrar" class="btn btn-danger mb-2">Cerrar Caja</button>
        </div>
        <div class="col-md-6 text-end">
            <small id="estadoCaja">Estado: --</small>
        </div>
    </div>

    <hr />

    <h4>Registrar Venta</h4>
    <div class="row g-2">
        <div class="col-auto">
            <input id="monto" type="number" step="0.01" class="form-control" placeholder="Monto S/" value="100.00">
        </div>
        <div class="col-auto">
            <button id="btnRegistrar" class="btn btn-primary">Registrar Venta</button>
        </div>
        <div class="col-auto">
            <button id="btnGenerarRecibo" class="btn btn-secondary">Generar Recibo (última venta)</button>
        </div>
        <div class="col-auto">
            <button id="btnEnviarSunat" class="btn btn-warning">Enviar a SUNAT (último recibo)</button>
        </div>
    </div>

    <hr />

    <h4>Últimos registros</h4>
    <pre id="resultado" style="height:250px; overflow:auto; background:#f8f9fa; padding:10px; border:1px solid #ddd;"></pre>
</div>

<!-- Bootstrap CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script>
const base = "../resources/php/caja/";

function mostrar(data){
    const el = document.getElementById('resultado');
    try{ el.innerText = typeof data === 'string' ? data : JSON.stringify(data, null, 2); }
    catch(e){ el.innerText = String(data); }
}

async function fetchJson(url, opts){
    const res = await fetch(url, opts);
    const text = await res.text();
    try{ return JSON.parse(text); }catch(e){ return text; }
}

async function actualizarEstado(){
    const r = await fetchJson(base + 'estado_caja.php');
    if (r && r.estado){
        document.getElementById('estadoCaja').innerText = `Estado: ${r.estado} (id:${r.id||'-'})`;
    } else {
        document.getElementById('estadoCaja').innerText = 'Estado: --';
    }
}

document.getElementById('btnAbrir').addEventListener('click', async ()=>{
    const r = await fetchJson(base + 'abrir_caja.php', { method: 'POST' });
    mostrar(r);
    actualizarEstado();
});

document.getElementById('btnCerrar').addEventListener('click', async ()=>{
    const r = await fetchJson(base + 'cerrar_caja.php', { method: 'POST' });
    mostrar(r);
    actualizarEstado();
});

document.getElementById('btnRegistrar').addEventListener('click', async ()=>{
    const monto = parseFloat(document.getElementById('monto').value) || 0;
    const r = await fetchJson(base + 'registrar_venta.php', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ monto }) });
    mostrar(r);
    actualizarEstado();
});

document.getElementById('btnGenerarRecibo').addEventListener('click', async ()=>{
    const r = await fetchJson(base + 'generar_recibo.php', { method: 'POST' });
    mostrar(r);
});

document.getElementById('btnEnviarSunat').addEventListener('click', async ()=>{
    const r = await fetchJson(base + 'enviar_sunat.php', { method: 'POST' });
    mostrar(r);
});

// estado inicial
actualizarEstado();
</script>

</body>
</html>
