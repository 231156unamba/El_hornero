<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Pedido - El Hornero</title>
  <script>
    // Verificar sesi√≥n al cargar
    if (!localStorage.getItem("token") || localStorage.getItem("rol") !== "pedido") {
      window.location.href = "login.html";
    }
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff6f0; 
      margin: 0;
      padding: 0;
    }
    header {
      background: #ff6f00; /* Naranja fuerte */
      color: white;
      padding: 18px;
      text-align: center;
      font-size: 26px;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-title {
      flex: 1;
      text-align: center;
    }
    .header-user {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 14px;
    }
    .btn-logout {
      background: #e64a19;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }
    .btn-logout:hover {
      background: #d84315;
    }
    .container {
      max-width: 900px;
      margin: 25px auto;
      background: #fff;
      padding: 25px;
      border-radius: 14px;
      box-shadow: 0 3px 14px rgba(0,0,0,0.18);
    }
    h2 { margin-top: 0; color: #e65100; }
    h3 { color: #d84315; margin-top: 30px; }
    label { font-weight: bold; margin-top: 15px; display: block; color: #bf360c; }
    select, input, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #d9a082;
      font-size: 16px;
      margin-top: 6px;
      background: #fff3e0;
    }
    .tarjeta-pedido {
      border: 1px solid #ffab80;
      border-radius: 10px;
      padding: 18px;
      background: #fff8f0; /* M√°s separaci√≥n visual */
      margin-top: 20px; /* M√°s espacio entre tarjetas */
      box-shadow: 0 2px 6px rgba(255,138,101,0.3);
    }
    .grid-2 { display: grid; grid-template-columns: 1fr 80px; gap: 15px; }
    .btn {
      background: #ff6e00;
      color: white;
      border: none;
      padding: 12px 18px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn:hover { background: #ff8a40; }
    .btn-small {
      padding: 7px 12px;
      font-size: 14px;
      background: #e64a19;
    }
    .btn-small:hover {
      background: #ff7043;
    }
    .row { display: flex; gap: 15px; margin-top: 10px; }
    .row div { flex: 1; }
    .item-header {
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      color: #d84315;
      font-size: 17px;
    }
    .item-line {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #ffe0cc;
      color: #5d4037;
      font-size: 15px;
    }
    .total-box {
      font-size: 24px;
      font-weight: bold;
      text-align: right;
      margin-top: 30px;
      color: #bf360c;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-title">Panel de Pedidos - El Hornero</div>
    <div class="header-user">
      <span id="nombreUsuario"></span>
      <button class="btn-logout" onclick="cerrarSesion()">Salir</button>
    </div>
  </header>
  <div class="container">
    <h2>Crear Pedido</h2>

    <label>Mesa</label>
    <select id="mesa">
      <option value="">Seleccione una mesa</option>
    </select>

    <label>Agregar Plato</label>
    <div class="row">
      <div>
        <select id="plato">
        </select>
        <div id="menuStatus" style="margin-top:6px;color:#bf360c;font-size:14px"></div>
      </div>
      <div>
        <input type="number" id="cantidad" min="1" placeholder="Cant." />
      </div>
      <button class="btn" onclick="agregarTarjeta()">+</button>
    </div>

    <label>Ajuste de precio externo</label>
    <div class="row">
      <input type="number" id="ajuste_precio" placeholder="Monto extra" step="0.10" />
      <textarea id="ajuste_descripcion" placeholder="Motivo del ajuste"></textarea>
    </div>

    <h3>Detalle del Pedido</h3>
    <div id="listaPedidos"></div>

    <h3 style="margin-top:28px;">Pedidos guardados</h3>
    <div id="pedidosList"></div>

    <div class="total-box">Total: S/ <span id="total">0.00</span></div>

    <button class="btn" id="btnCrearPedido" onclick="crearPedido()" style="width:100%; margin-top:20px; font-size:18px;" disabled>Crear Pedido</button>
  </div>

  <script>
    let total = 0;
    const API_URL = "http://localhost:8080/api"; // Ajusta la URL seg√∫n tu backend

    function actualizarBotonCrearPedido() {
      const tarjetas = document.querySelectorAll('.tarjeta-pedido');
      const btn = document.getElementById('btnCrearPedido');
      btn.disabled = tarjetas.length === 0;
    }

    // Obtener datos del usuario
    function obtenerDatosUsuario() {
      const usuario = JSON.parse(localStorage.getItem("usuario") || "{}");
      return usuario;
    }

    // Mostrar nombre del usuario en la cabecera
    function mostrarUsuario() {
      const usuario = obtenerDatosUsuario();
      const nombreUsuario = document.getElementById("nombreUsuario");
      if (usuario && usuario.nombre) {
        nombreUsuario.textContent = `üë§ ${usuario.nombre}`;
      }
    }

    // Cerrar sesi√≥n
    function cerrarSesion() {
      if (confirm("¬øDeseas cerrar sesi√≥n?")) {
        localStorage.removeItem("token");
        localStorage.removeItem("usuario");
        localStorage.removeItem("rol");
        window.location.href = "login.html";
      }
    }



    // Cargar mesas (est√°tico 1-9)
    function cargarMesas() {
      const mesaSelect = document.getElementById("mesa");
      mesaSelect.innerHTML = '<option value="">Seleccione una mesa</option>';
      for (let i = 1; i <= 9; i++) {
        let op = document.createElement("option");
        op.value = i;
        op.textContent = `Mesa ${i}`;
        mesaSelect.appendChild(op);
      }
    }

    // Cargar platos desde la BD y mostrar mensaje si no hay
    function cargarPlatos() {
      const statusEl = document.getElementById('menuStatus');
      statusEl.textContent = 'Cargando men√∫...';
      fetch('/resources/js/menu_api.php')
        .then(res => res.json())
        .then(menu => {
          console.log('menu_api response:', menu);
          const platoSelect = document.getElementById("plato");
          platoSelect.innerHTML = '';
          if (!menu || menu.length === 0) {
            let op = document.createElement("option");
            op.value = '';
            op.textContent = 'No hay platos disponibles';
            platoSelect.appendChild(op);
            statusEl.textContent = 'No hay platos disponibles';
            return;
          }
          menu.forEach(p => {
            let op = document.createElement("option");
            op.value = p.id;
            op.dataset.nombre = p.nombre;
            op.dataset.precio = p.precio;
            op.textContent = `${p.nombre} - S/ ${p.precio}`;
            platoSelect.appendChild(op);
          });
          statusEl.textContent = '';
        })
        .catch(err => {
          console.error('Error fetching menu_api:', err);
          const platoSelect = document.getElementById("plato");
          platoSelect.innerHTML = '';
          let op = document.createElement("option");
          op.value = '';
          op.textContent = 'Error al cargar men√∫';
          platoSelect.appendChild(op);
          document.getElementById('menuStatus').textContent = 'Error al cargar men√∫. Revisa consola.';
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      mostrarUsuario();
      cargarMesas();
      cargarPlatos();
      fetchPedidos();
      actualizarBotonCrearPedido();
    });

    function agregarTarjeta() {
      const platoSelect = document.getElementById("plato");
      const selectedOption = platoSelect.options[platoSelect.selectedIndex];
      
      // Intentar obtener datos de atributos, sino del texto
      let nombre = selectedOption.dataset.nombre;
      let precio = parseFloat(selectedOption.dataset.precio);
      
      // Si no hay atributos, extraer del texto "Nombre - S/ Precio"
      if (!nombre || isNaN(precio)) {
        const texto = selectedOption.textContent.trim();
        const partes = texto.split(' - S/ ');
        if (partes.length === 2) {
          nombre = partes[0];
          precio = parseFloat(partes[1]);
        }
      }
      
      const cantidad = parseInt(document.getElementById('cantidad').value);
      if (!cantidad || cantidad <= 0 || !nombre || isNaN(precio)) {
        alert('Por favor selecciona un plato v√°lido y cantidad');
        return;
      }
      
      const nombreCompleto = `${nombre} - S/ ${precio.toFixed(2)}`;
      const subtotal = precio * cantidad;
      total += subtotal;
      const cont = document.getElementById("listaPedidos");
      const card = document.createElement("div");
      card.className = "tarjeta-pedido";
      card.innerHTML = `
        <div class="item-header">
          <span>${nombreCompleto}</span>
          <span>S/ ${subtotal.toFixed(2)}</span>
        </div>
        <div class="item-line">Cantidad: ${cantidad}</div>
        <div class="item-line">Precio unitario: S/ ${precio.toFixed(2)}</div>
        <button class="btn btn-small" onclick="eliminar(this, ${subtotal})">Eliminar</button>
      `;
      cont.appendChild(card);
      document.getElementById('cantidad').value = '';
      actualizar();
      actualizarBotonCrearPedido();
    }

    function eliminar(boton, monto) {
      boton.parentElement.remove();
      total -= monto;
      actualizar();
      actualizarBotonCrearPedido();
    }

    function actualizar() {
      const extra = parseFloat(document.getElementById('ajuste_precio').value) || 0;
      document.getElementById("total").textContent = (total + extra).toFixed(2);
    }


    // Crear pedido (conexi√≥n a la BD)
    async function crearPedido() {
      const mesa = document.getElementById("mesa").value;
      const listaPedidosDiv = document.getElementById("listaPedidos");
      const tarjetas = listaPedidosDiv.querySelectorAll(".tarjeta-pedido");
      
      if (!mesa) {
        alert("Por favor selecciona una mesa");
        return;
      }
      if (tarjetas.length === 0) {
        alert("Por favor agrega al menos un plato al pedido");
        return;
      }
      
      let detalle = [];
      tarjetas.forEach(tarjeta => {
        const nombre = tarjeta.querySelector(".item-header span:first-child").textContent;
        const cantidadTexto = tarjeta.querySelector(".item-line:nth-child(2)").textContent;
        const cantidad = parseInt(cantidadTexto.match(/\d+/)[0]);
        detalle.push(`${nombre} x${cantidad}`);
      });
      
      const detalleTexto = detalle.join(", ");
      const data = new URLSearchParams();
      data.append('mesa', mesa);
      data.append('detalle', detalleTexto);
      
      try {
        const res = await fetch('/resources/js/pedido_api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: data,
          credentials: 'include'
        });
        const resp = await res.json();
        
        if (resp.success) {
          alert('‚úì Pedido creado exitosamente');
          document.getElementById("mesa").value = "";
          document.getElementById("cantidad").value = "";
          document.getElementById("ajuste_precio").value = "";
          document.getElementById("ajuste_descripcion").value = "";
          document.getElementById("listaPedidos").innerHTML = "";
          total = 0;
          actualizar();
          actualizarBotonCrearPedido();
          fetchPedidos();
        } else {
          alert('Error al crear pedido: ' + (resp.message || 'Desconocido'));
          console.error('Error response:', resp);
        }
      } catch (err) {
        alert('Error de conexi√≥n: ' + err.message);
        console.error('Fetch error:', err);
      }
    }

    // Obtener y mostrar pedidos guardados desde la BD
    function fetchPedidos() {
      fetch('/resources/js/pedido_api.php')
        .then(res => res.json())
        .then(pedidos => {
          console.log('pedido_api response:', pedidos);
          const cont = document.getElementById('pedidosList');
          cont.innerHTML = '';
          if (!pedidos || pedidos.length === 0) {
            cont.innerHTML = '<div style="color:#bf360c;padding:12px;background:#fff3e0;border-radius:8px">No hay pedidos guardados</div>';
            return;
          }
          pedidos.forEach(p => {
            const el = document.createElement('div');
            el.className = 'tarjeta-pedido';
            el.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div><strong>Mesa ${p.mesa}</strong></div>
                <div style="color:#d84315">${p.estado}</div>
              </div>
              <div style="margin-top:8px;color:#5d4037">${p.detalle}</div>
              <div style="margin-top:6px;font-size:0.9em;color:#8d6e63">${p.fecha}</div>
            `;
            cont.appendChild(el);
          });
        })
        .catch(err => {
          console.error('Error fetching pedidos:', err);
          const cont = document.getElementById('pedidosList');
          cont.innerHTML = '<div style="color:#bf360c;padding:12px;background:#fff3e0;border-radius:8px">Error al cargar pedidos</div>';
        });
    }

    document.getElementById('ajuste_precio').addEventListener('input', actualizar);
  </script>
</body>
</html>